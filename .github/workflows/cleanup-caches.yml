name: Cleanup Caches

on:
  # Nach jedem erfolgreichen Release
  workflow_run:
    workflows: ["Release"]
    types:
      - completed
  # Manuell auslösbar
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Cleanup old caches
        uses: actions/github-script@v8
        with:
          script: |
            const caches = await github.rest.actions.getActionsCacheList({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            console.log(`Found ${caches.data.total_count} caches`);

            // Gruppiere Caches nach Prefix (z.B. "Linux-pnpm-store", "v0-rust-build-desktop-Linux")
            const cacheGroups = {};
            for (const cache of caches.data.actions_caches) {
              // Extrahiere Prefix vor dem letzten Hash-Teil
              const parts = cache.key.split('-');
              // Finde den letzten Teil der wie ein Hash aussieht (8+ hex chars)
              let prefixParts = [];
              for (const part of parts) {
                if (/^[a-f0-9]{8,}$/i.test(part)) {
                  break;
                }
                prefixParts.push(part);
              }
              const prefix = prefixParts.join('-');

              if (!cacheGroups[prefix]) {
                cacheGroups[prefix] = [];
              }
              cacheGroups[prefix].push(cache);
            }

            // Für jede Gruppe: behalte nur den neuesten Cache, lösche den Rest
            let deletedCount = 0;
            for (const [prefix, groupCaches] of Object.entries(cacheGroups)) {
              // Sortiere nach Erstellungsdatum (neueste zuerst)
              groupCaches.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

              // Lösche alle außer dem neuesten
              for (let i = 1; i < groupCaches.length; i++) {
                const cache = groupCaches[i];
                console.log(`Deleting old cache: ${cache.key} (${cache.id})`);
                try {
                  await github.rest.actions.deleteActionsCacheById({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    cache_id: cache.id
                  });
                  deletedCount++;
                } catch (error) {
                  console.log(`Failed to delete cache ${cache.id}: ${error.message}`);
                }
              }
            }

            console.log(`Deleted ${deletedCount} old caches`);
