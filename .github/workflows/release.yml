name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  # Run tests first before creating release
  test:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies (Ubuntu)
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libssl-dev

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Rust tests
        run: cd src-tauri && cargo test

      - name: Run TypeScript tests
        run: pnpm test

  create-release:
    needs: test
    permissions:
      contents: write
    runs-on: ubuntu-22.04
    outputs:
      release_id: ${{ steps.create-release.outputs.release_id }}
      upload_url: ${{ steps.create-release.outputs.upload_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get version
        run: echo "PACKAGE_VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV

      - name: Generate release notes
        id: release-notes
        run: |
          # Get all tags sorted by version
          CURRENT_TAG="v${PACKAGE_VERSION}"
          echo "Current tag: $CURRENT_TAG"

          # Find the previous tag (the one before current in sorted list)
          PREVIOUS_TAG=$(git tag -l 'v*' --sort=-v:refname | grep -A1 "^${CURRENT_TAG}$" | tail -1)

          # If previous tag equals current (no match after), try another method
          if [ "$PREVIOUS_TAG" = "$CURRENT_TAG" ] || [ -z "$PREVIOUS_TAG" ]; then
            PREVIOUS_TAG=$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || echo "")
          fi

          echo "Previous tag: '$PREVIOUS_TAG'"

          if [ -z "$PREVIOUS_TAG" ] || [ "$PREVIOUS_TAG" = "$CURRENT_TAG" ]; then
            echo "No previous tag found, using all commits"
            COMMITS=$(git log --pretty=format:"%s|%b" --no-merges)
          else
            echo "Getting commits between $PREVIOUS_TAG and $CURRENT_TAG"
            COMMITS=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"%s|%b" --no-merges)
          fi

          echo "Commits found:"
          echo "$COMMITS" | head -20

          # Parse commits into categories (only conventional commits: feat, fix, break)
          BREAKING=""
          FEATURES=""
          FIXES=""

          while IFS='|' read -r subject body; do
            # Skip version bump commits
            if [[ "$subject" == "Bump version to"* ]]; then
              continue
            fi

            # Extract bullet points from body if present
            DETAILS=""
            if [ -n "$body" ]; then
              DETAILS=$(echo "$body" | grep -E "^- " | head -10 || true)
            fi

            # Check for breaking changes (break:, break(scope):, or BREAKING CHANGE in body)
            if [[ "$subject" == break:* ]] || [[ "$subject" == break\(*\):* ]] || [[ "$subject" == BREAKING* ]] || [[ "$body" == *"BREAKING CHANGE"* ]]; then
              CLEAN=$(echo "$subject" | sed 's/^break[^:]*: //' | sed 's/^BREAKING CHANGE: //')
              BREAKING="${BREAKING}- ${CLEAN}"$'\n'
              if [ -n "$DETAILS" ]; then
                BREAKING="${BREAKING}${DETAILS}"$'\n'
              fi
            elif [[ "$subject" == feat:* ]] || [[ "$subject" == feat\(*\):* ]] || [[ "$subject" == feature:* ]] || [[ "$subject" == feature\(*\):* ]]; then
              # Remove prefix and format
              CLEAN=$(echo "$subject" | sed 's/^feat[^:]*: //' | sed 's/^feature[^:]*: //')
              FEATURES="${FEATURES}- ${CLEAN}"$'\n'
              if [ -n "$DETAILS" ]; then
                FEATURES="${FEATURES}${DETAILS}"$'\n'
              fi
            elif [[ "$subject" == fix:* ]] || [[ "$subject" == fix\(*\):* ]]; then
              CLEAN=$(echo "$subject" | sed 's/^fix[^:]*: //')
              FIXES="${FIXES}- ${CLEAN}"$'\n'
              if [ -n "$DETAILS" ]; then
                FIXES="${FIXES}${DETAILS}"$'\n'
              fi
            fi
            # Ignore all other commits (chore, refactor, docs, etc.)
          done <<< "$COMMITS"

          # Build release notes
          NOTES=""

          if [ -n "$BREAKING" ]; then
            NOTES="${NOTES}## âš ï¸ Breaking Changes"$'\n\n'"${BREAKING}"$'\n'
          fi

          if [ -n "$FEATURES" ]; then
            NOTES="${NOTES}## âœ¨ Features"$'\n\n'"${FEATURES}"$'\n'
          fi

          if [ -n "$FIXES" ]; then
            NOTES="${NOTES}## ðŸ› Bug Fixes"$'\n\n'"${FIXES}"$'\n'
          fi

          # Fallback if no conventional commits found
          if [ -z "$NOTES" ]; then
            NOTES="Release v${PACKAGE_VERSION}"$'\n\n'"See commit history for changes."
          fi

          # Add download instructions
          NOTES="${NOTES}"$'\n'"---"$'\n\n'"ðŸ“¥ **Downloads**: See assets below for your platform."

          # Save to file (multi-line output)
          echo "$NOTES" > release_notes.md
          echo "Generated release notes:"
          cat release_notes.md

      - name: Create release
        id: create-release
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const releaseNotes = fs.readFileSync('release_notes.md', 'utf8');
            const tagName = `v${process.env.PACKAGE_VERSION}`;

            // Check if a release already exists for this tag
            let existingRelease = null;
            try {
              const { data: releases } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 10
              });
              existingRelease = releases.find(r => r.tag_name === tagName);
            } catch (e) {
              console.log('No existing releases found');
            }

            if (existingRelease) {
              console.log(`Found existing release for ${tagName}: ${existingRelease.id} (draft: ${existingRelease.draft})`);
              // Delete existing release to start fresh
              await github.rest.repos.deleteRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: existingRelease.id
              });
              console.log('Deleted existing release');
            }

            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tagName,
              name: `haex-vault v${process.env.PACKAGE_VERSION}`,
              body: releaseNotes,
              draft: true,
              prerelease: false
            })
            core.setOutput('release_id', data.id)
            core.setOutput('upload_url', data.upload_url)
            return data.id

  build-desktop:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''
          - platform: 'windows-latest'
            args: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install dependencies (Ubuntu)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libssl-dev

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v5
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Build and release Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: ${{ matrix.args }}

      # Upload Linux binary as artifact for E2E tests
      - name: Upload Linux binary for E2E tests
        if: matrix.platform == 'ubuntu-22.04'
        uses: actions/upload-artifact@v4
        with:
          name: haex-vault-linux-e2e
          path: src-tauri/target/release/haex-space
          retention-days: 1

  build-android:
    needs: create-release
    permissions:
      contents: write
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Rust Android targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add i686-linux-android
          rustup target add x86_64-linux-android

      - name: Setup NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d
        id: setup-ndk

      - name: Setup Android NDK environment for OpenSSL
        run: |
          echo "ANDROID_NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV
          echo "NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV

          # Add all Android toolchains to PATH for OpenSSL cross-compilation
          echo "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

          # Set CC, AR, RANLIB for each target
          echo "CC_aarch64_linux_android=aarch64-linux-android24-clang" >> $GITHUB_ENV
          echo "AR_aarch64_linux_android=llvm-ar" >> $GITHUB_ENV
          echo "RANLIB_aarch64_linux_android=llvm-ranlib" >> $GITHUB_ENV

          echo "CC_armv7_linux_androideabi=armv7a-linux-androideabi24-clang" >> $GITHUB_ENV
          echo "AR_armv7_linux_androideabi=llvm-ar" >> $GITHUB_ENV
          echo "RANLIB_armv7_linux_androideabi=llvm-ranlib" >> $GITHUB_ENV

          echo "CC_i686_linux_android=i686-linux-android24-clang" >> $GITHUB_ENV
          echo "AR_i686_linux_android=llvm-ar" >> $GITHUB_ENV
          echo "RANLIB_i686_linux_android=llvm-ranlib" >> $GITHUB_ENV

          echo "CC_x86_64_linux_android=x86_64-linux-android24-clang" >> $GITHUB_ENV
          echo "AR_x86_64_linux_android=llvm-ar" >> $GITHUB_ENV
          echo "RANLIB_x86_64_linux_android=llvm-ranlib" >> $GITHUB_ENV

      - name: Install build dependencies for OpenSSL
        run: |
          sudo apt-get update
          sudo apt-get install -y perl make

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v5
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-android-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-android-pnpm-store-

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          prefix-key: android

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Initialize Android project
        run: |
          rm -rf src-tauri/gen/android
          pnpm tauri android init

      - name: Update Kotlin version for biometry plugin
        run: |
          sed -i 's/kotlin-gradle-plugin:1.9.25/kotlin-gradle-plugin:2.1.0/' src-tauri/gen/android/build.gradle.kts

      - name: Generate app icons
        run: pnpm tauri icon app-icon.json

      - name: Setup Keystore and Signing Config
        run: |
          # Decode keystore from base64 secret
          echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 -d > /tmp/keystore.jks
          ls -la /tmp/keystore.jks

          # Create keystore.properties for Gradle signing config
          echo "storeFile=/tmp/keystore.jks" > src-tauri/gen/android/keystore.properties
          echo "storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> src-tauri/gen/android/keystore.properties
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> src-tauri/gen/android/keystore.properties
          echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> src-tauri/gen/android/keystore.properties

          # Copy pre-configured build.gradle.kts with signing config
          cp .github/android-signing-build.gradle.kts src-tauri/gen/android/app/build.gradle.kts

          echo "Keystore configured for signing"

      - name: Build Android APK and AAB (signed)
        run: pnpm tauri android build

      - name: Get version
        run: echo "PACKAGE_VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV

      - name: Rename Android artifacts
        run: |
          mv src-tauri/gen/android/app/build/outputs/apk/universal/release/app-universal-release.apk \
             src-tauri/gen/android/app/build/outputs/apk/universal/release/haex-vault_${PACKAGE_VERSION}_universal.apk
          mv src-tauri/gen/android/app/build/outputs/bundle/universalRelease/app-universal-release.aab \
             src-tauri/gen/android/app/build/outputs/bundle/universalRelease/haex-vault_${PACKAGE_VERSION}_universal.aab

      - name: Upload Android artifacts to Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.ref_name }} \
            src-tauri/gen/android/app/build/outputs/apk/universal/release/*.apk \
            src-tauri/gen/android/app/build/outputs/bundle/universalRelease/*.aab \
            --clobber

      # Upload Android APK as artifact for E2E tests
      - name: Upload Android APK for E2E tests
        uses: actions/upload-artifact@v4
        with:
          name: haex-vault-android-e2e
          path: src-tauri/gen/android/app/build/outputs/apk/universal/release/*.apk
          retention-days: 1

  # Run E2E tests after desktop and Android builds complete
  e2e-tests:
    needs: [create-release, build-desktop, build-android]
    uses: haex-space/haex-e2e-tests/.github/workflows/e2e-tests.yml@main
    with:
      build_type: release
      # Use pre-built binary from build-desktop job
      haex_vault_artifact: haex-vault-linux-e2e
      haex_vault_artifact_run_id: ${{ github.run_id }}
      # Use pre-built APK from build-android job
      haex_vault_android_artifact: haex-vault-android-e2e
      # Other components built from source
      haextension_version: main
      vault_sdk_version: main
      sync_server_version: main

  publish-release:
    permissions:
      contents: write
    runs-on: ubuntu-22.04
    needs: [create-release, build-desktop, build-android, e2e-tests]

    steps:
      - name: Publish release
        id: publish-release
        uses: actions/github-script@v7
        env:
          release_id: ${{ needs.create-release.outputs.release_id }}
        with:
          script: |
            github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: process.env.release_id,
              draft: false,
              prerelease: false
            })
